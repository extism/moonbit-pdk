<!DOCTYPE html>
<html>

<head></head>

<body>
  <script>
    const memory = new WebAssembly.Memory({ initial: 1, maximum: 1, shared: false })
    const fakeAlloc = { offset: 0, buffers: {} }

    const importObject = {
      "extism:host/env": {
        alloc: (lengthBigInt) => {
          const offset = fakeAlloc.offset
          const length = Number(lengthBigInt)
          fakeAlloc.buffers[offset] = {
            offset,
            length,
            buffer: new Uint8Array(memory.buffer, offset, length),
          }
          fakeAlloc.offset += length
          return BigInt(offset)
        },
        output_set: (offset) => console.log(new TextDecoder().decode(fakeAlloc.buffers[offset].buffer)),
        store_u8: (offsetBigInt, byte) => {
          const offset = Number(offsetBigInt)
          Object.keys(fakeAlloc.buffers).forEach((key) => {
            const b = fakeAlloc.buffers[key]
            if (offset >= b.offset && offset < b.offset + b.length) {
              b.buffer[offset - key] = byte
            }
          })
        },
      },
    }

    WebAssembly.instantiateStreaming(fetch("/target/wasm/release/build/examples/count-vowels/count-vowels.wasm"), importObject).then(
      (obj) => {
        obj.instance.exports._start()
        obj.instance.exports["count_vowels"]()
      }
    )
  </script>
</body>

</html>